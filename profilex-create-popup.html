<link rel="import" href="/node_modules/@polymer/polymer/polymer-element.html">
<link rel="import" href="/node_modules/@polymer/polymer/lib/elements/dom-if.html">
<link rel="import" href="/node_modules/@polymer/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="/node_modules_dev/profilex-common-css/components/profilex-common-css.html">
<link rel="import" href="/node_modules_dev/profilex-polymer-behaviors/api-behaviors.html">

<link rel="import">
<dom-module id="profilex-create-popup">

    <template>
    <style include="profilex-common-css">
        .popup-container {
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            padding-top: 100px;
            /* Location of the box */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }
        /* Modal Content */
        
        .popup-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 450px;
        }
        /* The Close Button */
        
        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        [hidden] {
            display: none !important;
        }
    </style>

    <template is="dom-if" if="{{showPopupBoolean}}" id="createpopup">
        <div class="popup-container" id="createpopup-container">
        <div class="popup-content">
            <span class="close" on-click="_closeBox">&times;</span>
            <div class="popup-header">
            <h2 class="popup-header-title">{{popupConfig.heading}}</h2>
        </div>
            <div class="popup-body">
                <template is="dom-if" if="{{!_isConfigReadyAsBool}}" id="ready-loading">
                    Loading..
                </template>
    <form name="create-profilex-form" id="create-popup-form">
        <template is="dom-repeat" items="{{popupConfig.fields}}">
                    <template is="dom-if" if="{{checkFieldType(item.type, 'text', item.showFieldOn)}}">
                        <div class="form-element-row">
                            <label>{{item.label}}: </label><input type="text" value="" name="{{item.name}}">
                        </div>
                    </template>
        <template is="dom-if" if="{{checkFieldType(item.type, 'radio', item.showFieldOn)}}">
                        <div class="form-element-row">
                            <label>{{item.label}}: </label>
                            <template is="dom-repeat" items="{{item.options}}" as="option">
                                <input type="radio" name="{{item.name}}" value="{{option.value}}"> {{option.value}}
                            </template>
        </div>
        </template>
        <template is="dom-if" if="{{checkFieldType(item.type, 'date', item.showFieldOn)}}">
                        <div class="form-element-row">
                            <label>{{item.label}}: </label><input type="date" value="" name="{{item.name}}">
                        </div>
                    </template>
        <template is="dom-if" if="{{checkFieldType(item.type, 'dropdown', item.showFieldOn)}}">
                        <div class="form-element-row">
                            <label>{{item.label}}: </label>
                            <select name="{{item.name}}">
                            <template is="dom-repeat" items="{{item.options}}" as="option">
                                <option value="{{option.value}}">{{option.name}}</option>
                            </template>
        </select>
        </div>
        </template>

        <template is="dom-if" if="{{checkFieldType(item.type, 'toggle', item.showFieldOn)}}">
            <div class="form-element-row">
                <a id="{{field.id}}" on-click="_toggle"> {{item.label}}</a>
            </div>
        </template>
    </form>
    </template>
    </div>

    <div class="popup-footer">
        <button class="button button-primary" on-click="_closeBox">{{popupConfig.button.cancel}}</button>
        <button class="button button-primary" on-click="_submitBox">{{popupConfig.button.add}}</button>
    </div>
    </div>
    </div>
    </template>

    </template>

    <script>
        /**
         * @customElement
         * @polymer
         */
        class ProfilexCreatePopup extends Polymer.Element {

            static get is() {
                return 'profilex-create-popup';
            }
            static get behaviors() {
                return [ApiBehaviors];
            }
            static get properties() {
                return {
                    showPopupBoolean: Boolean,
                    showPopup: {
                        type: String,
                        notify: true,
                        observer: '_showPopupToggle'
                    },
                    isConfigReady: {
                        type: String,
                        observer: '_onConfigReady'
                    },
                    _isConfigReadyAsBool: {
                        type: Boolean,
                        value: true
                    },
                    type: {
                        type: String,
                        observer: '_onTypeChanged'
                    },
                    layoutSchema: {
                        type: String,
                        observer: '_onLayoutChanged',
                    },
                    updatedLayoutSchema: {
                        type: Object,
                        value: {},
                    },
                    popupConfig: {
                        type: Object,
                        notify: true
                    }
                };
            }
            ready() {
                super.ready();
                this.showPopupBoolean = true;
                this.setAttribute('show-popup', true);
            }
            _closeBox() {
                this.showPopupBoolean = false;
                this.setAttribute('show-popup', false);
            }
            _showPopupToggle() {
                if (this.showPopup.toLowerCase() == 'true') {
                    this.showPopupBoolean = true;
                } else {
                    this.showPopupBoolean = false;
                }
            }
            _submitBox() {
                var formData = new FormData(document.getElementById('create-popup-form'));
                console.log(formData);
            }
            _onLayoutChanged() {
                if (this.layoutSchema) {
                    this.onBeforeLoadConfig(JSON.parse(this.layoutSchema));
                }
            }
            _onTypeChanged() {
                if (this.type && !this.layoutSchema) {
                    //Load layout schema based on the type
                    ApiBehaviors.loadJSON('/node_modules_dev/profilex-create-popup/layoutSchema/' + this.type + '.json', function(response) {
                        // Parse JSON string into object
                        //this.onBeforeLoadConfig(JSON.parse(response));
                        this.layoutSchema = response;
                    }.bind(this));
                }
            }

            _onConfigReady() {
                this._isConfigReadyAsBool = (this.isConfigReady == undefined || (this.isConfigReady.toLowerCase() == 'true'));
                //this.onBeforeLoadConfig(this.layoutSchema);
            }
            onBeforeLoadConfig(layoutSchema) {
                //this.callFunc = new Function('return ' + this.onPopupLoad);
                //this.callFunc(); // can now be called here or elsewhere in the Polymer object
                if (this._isConfigReadyAsBool) {
                    layoutSchema.fields.forEach(function(field) {
                        if (field.type == "toggle") {
                            this[field.modelKey] = field.value;
                            field.label = (field.value) ? field.labelOn : field.labelOff;
                        }
                    }.bind(this));
                    this.popupConfig = layoutSchema;
                } else {
                    this.event = new CustomEvent('pre-load-config', {
                        detail: {
                            layoutSchema: layoutSchema
                        }
                    });
                    window.dispatchEvent(this.event);
                }
            }
            checkFieldType(fieldType, value, showFieldOn) {
                return (fieldType == value && (!showFieldOn || this[showFieldOn]));
            }
            _toggle(e) {
                var fieldIndex = e.model.__data.index;
                var field = e.model.__data.item;
                field.value = !field.value;
                field.label = (field.value) ? field.labelOn : field.labelOff;
                this.popupConfig.fields[fieldIndex] = field;
                var tmp = this.popupConfig;
                //this.onBeforeLoadConfig(this.popupConfig);
                this.set('popupConfig', []);
                this.$.createpopup.render();
                this[field.modelKey] = field.value;
                this.set('popupConfig', tmp);
                this.$.createpopup.render();
            }
        }

        window.customElements.define(ProfilexCreatePopup.is, ProfilexCreatePopup);
    </script>
</dom-module>